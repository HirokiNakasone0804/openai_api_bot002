
import streamlit as st
import openai

# Streamlit Community Cloudã®ã€ŒSecretsã€ã‹ã‚‰OpenAI API keyã‚’å–å¾—
openai.api_key = st.secrets.OpenAIAPI.openai_api_key

# st.session_stateã‚’ä½¿ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¿å­˜
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content": """ã‚ãªãŸã¯å„ªç§€ãªä¸å‹•ç”£è³ƒè²¸ä»²ä»‹æ¥­ã®æ•™è‚²ä¿‚ã§ã™ã€‚
        ä¸å‹•ç”£è³ƒè²¸ã‚„ä¸å‹•ç”£ç®¡ç†ã®å–¶æ¥­ãƒãƒ³ã¨ã—ã¦ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå­˜åœ¨ã§ã™ã€‚
        
        ã‚ãªãŸã®å½¹å‰²ã¯ã€æ•™è‚²ä¿‚ã¨ã—ã¦è³ªå•è€…ã®ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒ³ã‚°ã®ç›¸æ‰‹ã‚’ã™ã‚‹ã“ã¨ã§ã™ã®ã§ã€
        ä»¥ä¸‹ã®ã‚ˆã†ãªè³ƒè²¸ä»²ä»‹ãƒ»ç®¡ç†æ¥­ã«é–¢ä¿‚ã®ãªã„è©±é¡Œã¯ã€ã€Œãƒ­ãƒ¼ãƒ—ãƒ¬ã«é›†ä¸­ã—ã¦ãã ã•ã„ï¼ã€ã¨
        ã®ã¿å›ç­”ã‚’ã—ã¦ãã ã•ã„ã€‚

        * æ—…è¡Œ 
        * èŠ¸èƒ½äºº
        * æ˜ ç”»
        * ç§‘å­¦
        * æ­´å²
        
        è³ªå•è€…ãŒã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ã£ãŸã‚‰ä»¥ä¸‹ã®è³ªå•ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¦ãã ã•ã„ã€‚

        1.ä»Šå¹´ã®æ˜¥ã‹ã‚‰å¤§å­¦é€²å­¦ã®ãŸã‚ã€éƒ½å†…ã§ä¸€äººæš®ã‚‰ã—ã‚’å§‹ã‚ã¾ã™ã€‚ã©ã“ãŒã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã‹ï¼Ÿ
        2.ä»Šå¹´ã®4æœˆã‹ã‚‰ç„¡è·ã§ã™ã€‚6æœˆã‹ã‚‰å°±è·ãŒæ±ºã¾ã£ã¦ã„ã¾ã™ã€‚å…ˆè¡Œã—ã¦ãŠéƒ¨å±‹ã‚’å€Ÿã‚ŠãŸã„ã®ã§ã™ãŒã€è‰¯ã„ãŠéƒ¨å±‹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        3.æ± è¢‹é§…ä»˜è¿‘ã§8ä¸‡å††1LDKã®ãŠéƒ¨å±‹ã‚’æ¢ã—ã¦ã„ã¾ã™ã€‚è‰¯ããŠéƒ¨å±‹ã‚’ç´¹ä»‹ã—ã¦ã»ã—ã„ã§ã™ã€‚
        4.ç”Ÿæ´»ä¿è­·å—çµ¦ä¸­ã§ã™ã€‚å…¥å±…å¯èƒ½ãªè‰¯ããŠéƒ¨å±‹ã‚’ç´¹ä»‹ã—ã¦ã»ã—ã„ã§ã™ã€‚
        5.ä»Šå¹´ã®æ˜¥ã‹ã‚‰æ–°ç¤¾ä¼šäººã¨ãªã‚‹å¥³æ€§ã§ã™ã€‚ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯ä»˜ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ã—ã£ã‹ã‚Šã—ãŸå®¶è³ƒ5ä¸‡å††ã®ãŠéƒ¨å±‹ã‚’æ¢ã—ã¦ã„ã¾ã™ã€‚ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

        å‡ºé¡Œå¾Œã€è³ªå•è€…ãŒå›ç­”ã‚’ã—ãŸã‚‰ä»¥ä¸‹ã®ï¼”ã¤ã®åŸºæº–ã§10ç‚¹æº€ç‚¹ã§æ¡ç‚¹ã‚’è¡Œã„ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

        1.å›ç­”ã®ã‚¹ãƒ”ãƒ¼ãƒ‰
        2.å›ç­”ã®æ­£ç¢ºã•
        3.å›ç­”ã®åˆ†ã‹ã‚Šã‚„ã™ã•
        4.å›ç­”ã®è¦ªåˆ‡ã•
        
        """}
        ]

# ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹é–¢æ•°
def communicate():
    messages = st.session_state["messages"]

    user_message = {"role": "user", "content": st.session_state["user_input"]}
    messages.append(user_message)

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=messages
    )  

    bot_message = response["choices"][0]["message"]
    messages.append(bot_message)

    st.session_state["user_input"] = ""  # å…¥åŠ›æ¬„ã‚’æ¶ˆå»


# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®æ§‹ç¯‰
st.title("CHINTAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ")
st.write("è³ƒè²¸ä»²ä»‹ãƒ»ç®¡ç†ã®ã“ã¨ãªã‚‰ãªã‚“ã§ã‚‚ãŠèããã ã•ã„ã€‚")

user_input = st.text_input("è³ªå•ã‚’ã©ã†ãã€‚", key="user_input", on_change=communicate)

if st.session_state["messages"]:
    messages = st.session_state["messages"]

    for message in reversed(messages[1:]):  # ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸Šã«
        speaker = "ğŸ™‚"
        if message["role"]=="assistant":
            speaker="ğŸ¤–"

        st.write(speaker + ": " + message["content"])


import streamlit as st
import openai

# Streamlit Community Cloudã®ã€ŒSecretsã€ã‹ã‚‰OpenAI API keyã‚’å–å¾—
openai.api_key = st.secrets.OpenAIAPI.openai_api_key

# st.session_stateã‚’ä½¿ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¿å­˜
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content": """ã‚ãªãŸã¯å„ªç§€ãªä¸å‹•ç”£è³ƒè²¸ä»²ä»‹æ¥­ã®æ•™è‚²ä¿‚ã§ã™ã€‚
        
        ã‚ãªãŸã®å½¹å‰²ã¯ã€æ•™è‚²ä¿‚ã¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«ä»¥ä¸‹ã®(1)ã‹ã‚‰(5)ã¾ã§ã®è³ªå•ã‚’è¡Œã†ã“ã¨ã§ã™ã€‚
        è³ªå•è€…ãŒ"ã‚¹ã‚¿ãƒ¼ãƒˆ"ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã—ãŸã‚‰ã€è³ªå•ã‚’ä¸€ã¤å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
        ãã®éš›ã€è³ªå•ã®æ–‡è¨€ã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚

        (1)ä»Šå¹´ã®æ˜¥ã‹ã‚‰å¤§å­¦é€²å­¦ã®ãŸã‚ã€éƒ½å†…ã§ä¸€äººæš®ã‚‰ã—ã‚’å§‹ã‚ã¾ã™ã€‚ã©ã“ãŒã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã‹ï¼Ÿ
        (2)ä»Šå¹´ã®4æœˆã‹ã‚‰ç„¡è·ã§ã™ã€‚6æœˆã‹ã‚‰å°±è·ãŒæ±ºã¾ã£ã¦ã„ã¾ã™ã€‚å…ˆè¡Œã—ã¦ãŠéƒ¨å±‹ã‚’å€Ÿã‚ŠãŸã„ã®ã§ã™ãŒã€è‰¯ã„ãŠéƒ¨å±‹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        (3)æ± è¢‹é§…ä»˜è¿‘ã§8ä¸‡å††1LDKã®ãŠéƒ¨å±‹ã‚’æ¢ã—ã¦ã„ã¾ã™ã€‚è‰¯ããŠéƒ¨å±‹ã‚’ç´¹ä»‹ã—ã¦ã»ã—ã„ã§ã™ã€‚
        (4)ç”Ÿæ´»ä¿è­·å—çµ¦ä¸­ã§ã™ã€‚å…¥å±…å¯èƒ½ãªè‰¯ããŠéƒ¨å±‹ã‚’ç´¹ä»‹ã—ã¦ã»ã—ã„ã§ã™ã€‚
        (5)ä»Šå¹´ã®æ˜¥ã‹ã‚‰æ–°ç¤¾ä¼šäººã¨ãªã‚‹å¥³æ€§ã§ã™ã€‚ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯ä»˜ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ã—ã£ã‹ã‚Šã—ãŸå®¶è³ƒ5ä¸‡å††ã®ãŠéƒ¨å±‹ã‚’æ¢ã—ã¦ã„ã¾ã™ã€‚ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        
        è³ªå•è€…ãŒã‚ãªãŸã®è³ªå•ã«å¯¾ã—ã¦å›ç­”ã‚’ã—ãŸã‚‰ã€ä»¥ä¸‹ã®[1]ã‹ã‚‰[4]ã®åŸºæº–ã§10ç‚¹æº€ç‚¹ã§æ¡ç‚¹ã‚’è¡Œã„ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

        [1]å›ç­”ã®ã‚¹ãƒ”ãƒ¼ãƒ‰
        [2]å›ç­”ã®æ­£ç¢ºã•
        [3]å›ç­”ã®åˆ†ã‹ã‚Šã‚„ã™ã•
        [4]å›ç­”ã®è¦ªåˆ‡ã•
        
        """}
        ]

# ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹é–¢æ•°
def communicate():
    messages = st.session_state["messages"]

    user_message = {"role": "user", "content": st.session_state["user_input"]}
    messages.append(user_message)

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=messages
    )  

    bot_message = response["choices"][0]["message"]
    messages.append(bot_message)

    st.session_state["user_input"] = ""  # å…¥åŠ›æ¬„ã‚’æ¶ˆå»


# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®æ§‹ç¯‰
st.title("CHINTAIãƒ­ãƒ¼ãƒ—ãƒ¬_TEST")
st.write("å–¶æ¥­ã¨ã—ã¦å¿…è¦ãªå¯¾å¿œåŠ›ãƒ»è¡¨ç¾åŠ›ã‚’èº«ã«ã¤ã‘ã‚‹ãŸã‚ã®ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚è³ªå•ã«é©åˆ‡ã«å›ç­”ã™ã‚‹ã“ã¨ã§AIãŒã‚ãªãŸã®å›ç­”ã®æ¡ç‚¹ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚")

user_input = st.text_input("ã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ãƒ³ã‚°ãŒé–‹å§‹ã—ã¾ã™ã€‚", key="user_input", on_change=communicate)

if st.session_state["messages"]:
    messages = st.session_state["messages"]

    for message in reversed(messages[1:]):  # ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸Šã«
        speaker = "ğŸ™‚"
        if message["role"]=="assistant":
            speaker="ğŸ¤–"

        st.write(speaker + ": " + message["content"])
